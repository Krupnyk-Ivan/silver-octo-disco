<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TacticalMed - Student UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="row mb-4">
        <div class="col">
          <h1 class="h3">TacticalMed — Student UI</h1>
          <p class="text-muted">Submit answers and view review results (mock AI scoring).</p>
        </div>
      </div>

      <div class="row">
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Submit Answer</h5>
              <form id="submitForm">
                <div class="mb-2">
                  <label class="form-label">Student ID</label>
                  <input class="form-control" name="studentId" id="studentId" value="student1" required />
                </div>
                <div class="mb-2">
                  <label class="form-label">Question</label>
                  <input class="form-control" name="question" id="question" value="What is the first step for massive hemorrhage?" required />
                </div>
                <div class="mb-3">
                  <label class="form-label">Answer</label>
                  <textarea class="form-control" name="answerText" id="answerText" rows="4">Apply a tourniquet and direct pressure</textarea>
                </div>
                <button class="btn btn-primary" type="submit">Submit</button>
                <span id="submitStatus" class="ms-3"></span>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Lookup Submission</h5>
              <div class="input-group">
                <input id="lookupId" class="form-control" placeholder="Submission id (GUID)" />
                <button id="lookupBtn" class="btn btn-outline-secondary">Lookup</button>
              </div>
            </div>
          </div>
          
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Recent Submissions</h5>
              <div id="submissionsList" style="max-height:300px;overflow:auto">
                <div class="text-muted">Loading...</div>
              </div>
              <div class="mt-2"><small class="text-muted">Click an item to load details (UI polls for updates).</small></div>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Result</h5>
              <pre id="resultArea" style="white-space:pre-wrap;word-break:break-word;">No results yet.</pre>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">AI Review</h5>
              <div class="mb-2">
                <small>Realtime status: <span id="realtimeIndicator" class="badge bg-secondary">Disconnected</span></small>
              </div>
              <div id="aiReview">
                <div><strong>Status:</strong> <span id="aiStatus">-</span></div>
                <div><strong>Score:</strong> <span id="aiScore">-</span></div>
                <div class="mt-2"><strong>Feedback:</strong>
                  <div id="aiFeedback" style="white-space:pre-wrap;word-break:break-word;">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="mt-4 text-muted">Gateway: {{ gateway }} — RabbitMQ-backed review flow</footer>
    </div>

    <script>
      // Polling client to receive review updates from the API
      let pollTimer = null;

      function startPollFor(id) {
        stopPoll();
        if (!id) return;
        const poll = async () => {
          try {
            const r = await fetch(`/api/get/${encodeURIComponent(id)}`);
            if (r.status === 200) {
              const data = await r.json();
              document.getElementById('aiStatus').textContent = data.status || '-';
              document.getElementById('aiScore').textContent = (data.score !== undefined && data.score !== null) ? String(data.score) : '-';
              document.getElementById('aiFeedback').textContent = data.feedback || data.feedbackText || data.Feedback || '-';
              try {
                document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
              } catch(_) {}
            }
          } catch (e) { /* ignore transient errors */ }
        };
        // Poll every 7 seconds
        poll();
        pollTimer = setInterval(poll, 7000);
        setRealtime('polling');
      }

      function stopPoll() {
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        setRealtime('disconnected');
      }

      function setRealtime(mode) {
        const el = document.getElementById('realtimeIndicator');
        if (!el) return;
        if (mode === 'polling') {
          el.textContent = 'Polling';
          el.className = 'badge bg-warning text-dark';
        } else {
          el.textContent = 'Disconnected';
          el.className = 'badge bg-secondary';
        }
      }

      // SSE removed; UI uses polling-only

      // Fetch and render recent submissions into the left-side list
      async function refreshSubmissions() {
        const container = document.getElementById('submissionsList');
        if (!container) return;
        container.innerHTML = '<div class="text-muted">Loading...</div>';
        try {
          const r = await fetch('/api/list');
          if (r.status !== 200) {
            container.innerHTML = '<div class="text-danger">Failed to load</div>';
            return;
          }
          const data = await r.json();
          if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = '<div class="text-muted">No submissions yet.</div>';
            return;
          }
          // Render clickable list
          container.innerHTML = '';
          data.forEach(item => {
            const id = item.id || item.Id || item.Id;
            const student = item.studentId || item.StudentId || '-';
            const q = item.question || item.Question || '-';
            const status = item.status || item.Status || '-';

            const el = document.createElement('div');
            el.className = 'p-2 border-bottom';
            el.style.cursor = 'pointer';
            el.innerHTML = `
              <div class="d-flex justify-content-between">
                <div><strong>${student}</strong></div>
                <div><small class="text-muted">${status}</small></div>
              </div>
              <div><small>${q}</small></div>
              <div><small class="text-break text-muted">${id}</small></div>
            `;
            el.addEventListener('click', () => {
              if (!id) return;
              document.getElementById('lookupId').value = id;
              document.getElementById('lookupBtn').click();
              // scroll to result area for convenience
              document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
            });
            container.appendChild(el);
          });
        } catch (e) {
          container.innerHTML = '<div class="text-danger">Error loading list</div>';
        }
      }

      // Refresh submissions on load and periodically
      try { refreshSubmissions(); } catch(_) {}
      setInterval(refreshSubmissions, 10000);

      async function postJson(path, body) {
        const resp = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(body)
        });
        return resp;
      }

      document.getElementById('submitForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          StudentId: document.getElementById('studentId').value,
          Question: document.getElementById('question').value,
          AnswerText: document.getElementById('answerText').value
        };
        const statusEl = document.getElementById('submitStatus');
        statusEl.textContent = 'Submitting...';
        try {
          const r = await postJson('/api/submit', payload);
          const data = await r.json();
          statusEl.textContent = r.ok ? 'Submitted' : 'Error';
          document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
          // Accept either `id` or `Id` depending on server JSON casing
          const submittedId = (data && (data.id || data.Id || data.Id)) || null;
          if (submittedId) {
            document.getElementById('lookupId').value = submittedId;
            // Start polling for this submission id so UI receives reviews
            try { startPollFor(submittedId); } catch(e) { console.warn('startPollFor failed', e); }
          }
          // clear any previous AI review fields (prefer server keys if returned)
          document.getElementById('aiStatus').textContent = data && (data.status || data.Status) ? (data.status || data.Status) : '-';
          document.getElementById('aiScore').textContent = data && (data.score !== undefined && data.score !== null) ? String(data.score ?? data.Score ?? '-') : '-';
          document.getElementById('aiFeedback').textContent = data && (data.feedback || data.Feedback || data.feedbackText) ? (data.feedback || data.Feedback || data.feedbackText) : '-';
        } catch (err) {
          statusEl.textContent = 'Network error';
          document.getElementById('resultArea').textContent = String(err);
        }
      });

      document.getElementById('lookupBtn').addEventListener('click', async () => {
        const id = document.getElementById('lookupId').value.trim();
        if (!id) return;
        document.getElementById('resultArea').textContent = 'Looking up...';
        try {
          const r = await fetch(`/api/get/${encodeURIComponent(id)}`);
            if (r.status === 200) {
            const data = await r.json();
            document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
            // Show AI review fields if present
            document.getElementById('aiStatus').textContent = data.status || '-';
            document.getElementById('aiScore').textContent = (data.score !== undefined && data.score !== null) ? String(data.score) : '-';
            document.getElementById('aiFeedback').textContent = data.feedback || data.feedbackText || data.Feedback || '-';
            // Start polling for this submission id so UI receives future reviews
            try { startPollFor(id); } catch(e) { console.warn('startPollFor failed', e); }
          } else {
            const text = await r.text();
            document.getElementById('resultArea').textContent = text;
            document.getElementById('aiStatus').textContent = '-';
            document.getElementById('aiScore').textContent = '-';
            document.getElementById('aiFeedback').textContent = '-';
          }
        } catch (err) {
          document.getElementById('resultArea').textContent = String(err);
          document.getElementById('aiStatus').textContent = '-';
          document.getElementById('aiScore').textContent = '-';
        }
      });
    </script>

  </body>
</html>
