<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TacticalMed - Student UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="row mb-4">
        <div class="col">
          <h1 class="h3">TacticalMed — Інтерфейс студента</h1>
          <p class="text-muted">Надішліть відповіді та переглядайте результати оцінювання (штучний інтелект).</p>
        </div>
      </div>

      <div class="row">
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Надіслати відповідь</h5>
              <div class="mb-2 text-end">
                <a href="/quiz" class="btn btn-sm btn-outline-primary">Розпочати тест (5 запитань)</a>
              </div>
              <form id="submitForm">
                <div class="mb-2">
                  <label class="form-label">ID студента</label>
                  <input class="form-control" name="studentId" id="studentId" value="student1" required />
                </div>
                <div class="mb-2">
                  <label class="form-label">Питання</label>
                  <div class="d-flex gap-2">
                    <select id="questionSelect" class="form-select" aria-label="Choose question">
                      <option value="__custom__">-- Custom / type your own --</option>
                    </select>
                    <button id="refreshQuestions" type="button" class="btn btn-outline-secondary">Refresh</button>
                  </div>
                  <input class="form-control mt-2" name="question" id="question" placeholder="Введіть власне питання або оберіть зі списку" required />
                </div>
                <div class="mb-3">
                  <label class="form-label">Відповідь</label>
                  <textarea class="form-control" name="answerText" id="answerText" rows="4">Застосувати джгут та прямий тиск</textarea>
                </div>
                <button class="btn btn-primary" type="submit">Надіслати</button>
                <span id="submitStatus" class="ms-3"></span>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Пошук надсилання</h5>
              <div class="input-group">
                <input id="lookupId" class="form-control" placeholder="ID надсилання (GUID)" />
                <button id="lookupBtn" class="btn btn-outline-secondary">Пошук</button>
              </div>
            </div>
          </div>
          
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Останні надсилання</h5>
              <div id="submissionsList" style="max-height:300px;overflow:auto">
                <div class="text-muted">Loading...</div>
              </div>
              <div class="mt-2"><small class="text-muted">Клацніть елемент, щоб переглянути деталі (інтерфейс опитує сервер).</small></div>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Результат</h5>
              <pre id="resultArea" style="white-space:pre-wrap;word-break:break-word;">Поки що немає результатів.</pre>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Огляд AI</h5>
              <div class="mb-2">
                <small>Статус: <span id="realtimeIndicator" class="badge bg-secondary">Відключено</span></small>
              </div>
              <div id="aiReview">
                <div><strong>Статус:</strong> <span id="aiStatus">-</span></div>
                <div><strong>Оцінка:</strong> <span id="aiScore">-</span></div>
                <div class="mt-2"><strong>Коментар:</strong>
                  <div id="aiFeedback" style="white-space:pre-wrap;word-break:break-word;">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="mt-4 text-muted">Шлюз: {{ gateway }} — потік перевірки через RabbitMQ</footer>
    </div>

    <script>
      // Load questions from server and populate select
      async function loadQuestions() {
        const sel = document.getElementById('questionSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="__custom__">-- Custom / type your own --</option>';
        try {
          const r = await fetch('/api/questions');
          if (r.status !== 200) return;
          const data = await r.json();
          if (!Array.isArray(data)) return;
          data.forEach(q => {
            const id = q.id || q.Id || q.Id;
            const title = q.title || q.Title || (q.text || q.Text || '').slice(0,60);
            const opt = document.createElement('option');
            opt.value = id || (q.text || q.Text || '');
            opt.textContent = title;
            // Attach full text for use when selected
            opt.dataset.full = q.text || q.Text || '';
            sel.appendChild(opt);
          });
        } catch (e) {
          console.warn('loadQuestions failed', e);
        }
      }

      document.getElementById('refreshQuestions').addEventListener('click', () => loadQuestions());

      document.getElementById('questionSelect').addEventListener('change', (e) => {
        const v = e.target.value;
        const input = document.getElementById('question');
        const opt = e.target.selectedOptions && e.target.selectedOptions[0];
        if (!input) return;
        if (v === '__custom__') {
          input.removeAttribute('readonly');
          input.value = '';
          input.focus();
        } else {
          // if the option has dataset.full use it, otherwise use value
          input.value = opt && opt.dataset && opt.dataset.full ? opt.dataset.full : v;
          input.setAttribute('readonly', 'true');
        }
      });

      // Load questions on initial page load
      try { loadQuestions(); } catch(_) {}

      // Polling client to receive review updates from the API
      let pollTimer = null;

      function startPollFor(id) {
        stopPoll();
        if (!id) return;
        const poll = async () => {
          try {
            const r = await fetch(`/api/get/${encodeURIComponent(id)}`);
            if (r.status === 200) {
              const data = await r.json();
              document.getElementById('aiStatus').textContent = data.status || '-';
              document.getElementById('aiScore').textContent = (data.score !== undefined && data.score !== null) ? String(data.score) : '-';
              document.getElementById('aiFeedback').textContent = data.feedback || data.feedbackText || data.Feedback || '-';
              try {
                document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
              } catch(_) {}
            }
          } catch (e) { /* ignore transient errors */ }
        };
        // Poll every 7 seconds
        poll();
        pollTimer = setInterval(poll, 7000);
        setRealtime('polling');
      }

      function stopPoll() {
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        setRealtime('disconnected');
      }

      function setRealtime(mode) {
        const el = document.getElementById('realtimeIndicator');
        if (!el) return;
        if (mode === 'polling') {
          el.textContent = 'Polling';
          el.className = 'badge bg-warning text-dark';
        } else {
          el.textContent = 'Disconnected';
          el.className = 'badge bg-secondary';
        }
      }

      // SSE removed; UI uses polling-only

      // Fetch and render recent submissions into the left-side list
      async function refreshSubmissions() {
        const container = document.getElementById('submissionsList');
        if (!container) return;
        container.innerHTML = '<div class="text-muted">Loading...</div>';
        try {
          const r = await fetch('/api/list');
          if (r.status !== 200) {
            container.innerHTML = '<div class="text-danger">Failed to load</div>';
            return;
          }
          const data = await r.json();
          if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = '<div class="text-muted">No submissions yet.</div>';
            return;
          }
          // Render clickable list
          container.innerHTML = '';
          data.forEach(item => {
            const id = item.id || item.Id || item.Id;
            const student = item.studentId || item.StudentId || '-';
            const q = item.question || item.Question || '-';
            const status = item.status || item.Status || '-';

            const el = document.createElement('div');
            el.className = 'p-2 border-bottom';
            el.style.cursor = 'pointer';
            el.innerHTML = `
              <div class="d-flex justify-content-between">
                <div><strong>${student}</strong></div>
                <div><small class="text-muted">${status}</small></div>
              </div>
              <div><small>${q}</small></div>
              <div><small class="text-break text-muted">${id}</small></div>
            `;
            el.addEventListener('click', () => {
              if (!id) return;
              document.getElementById('lookupId').value = id;
              document.getElementById('lookupBtn').click();
              // scroll to result area for convenience
              document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
            });
            container.appendChild(el);
          });
        } catch (e) {
          container.innerHTML = '<div class="text-danger">Error loading list</div>';
        }
      }

      // Refresh submissions on load and periodically
      try { refreshSubmissions(); } catch(_) {}
      setInterval(refreshSubmissions, 10000);

      async function postJson(path, body) {
        const resp = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(body)
        });
        return resp;
      }

      document.getElementById('submitForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const studentId = document.getElementById('studentId').value;
        const answerText = document.getElementById('answerText').value;
        const questionInput = document.getElementById('question');
        const questionSelect = document.getElementById('questionSelect');

        // Determine question text. If user chose custom, create the question in DB first
        let questionText = questionInput.value || '';
        if (questionSelect && questionSelect.value === '__custom__') {
          // create question record via UI proxy
          try {
            const title = questionText ? (questionText.substring(0, 60)) : 'Custom question';
            const createResp = await postJson('/api/questions', { Title: title, Text: questionText });
            if (createResp && createResp.ok) {
              const created = await createResp.json();
              // use returned text if available
              questionText = created.text || created.Text || questionText;
              // add to select for convenience
              try {
                const opt = document.createElement('option');
                opt.value = created.id || created.Id || '';
                opt.textContent = created.title || created.Title || (questionText.substring(0,60));
                opt.dataset.full = questionText;
                // insert after the custom option
                questionSelect.appendChild(opt);
                questionSelect.value = opt.value || opt.textContent;
                questionInput.setAttribute('readonly','true');
              } catch (e) { console.warn('Adding created option failed', e); }
            } else {
              // creation failed; continue but still submit the text as-is
              console.warn('Question creation returned non-OK');
            }
          } catch (err) {
            console.warn('Failed creating question', err);
          }
        } else if (questionSelect && questionSelect.value && questionSelect.value !== '__custom__') {
          const opt = questionSelect.selectedOptions && questionSelect.selectedOptions[0];
          questionText = opt && opt.dataset && opt.dataset.full ? opt.dataset.full : questionText;
        }

        const payload = {
          StudentId: studentId,
          Question: questionText,
          AnswerText: answerText
        };
        const statusEl = document.getElementById('submitStatus');
        statusEl.textContent = 'Submitting...';
        try {
          const r = await postJson('/api/submit', payload);
          const data = await r.json();
          statusEl.textContent = r.ok ? 'Submitted' : 'Error';
          document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
          // Accept either `id` or `Id` depending on server JSON casing
          const submittedId = (data && (data.id || data.Id || data.Id)) || null;
          if (submittedId) {
            document.getElementById('lookupId').value = submittedId;
            // Start polling for this submission id so UI receives reviews
            try { startPollFor(submittedId); } catch(e) { console.warn('startPollFor failed', e); }
          }
          // clear any previous AI review fields (prefer server keys if returned)
          document.getElementById('aiStatus').textContent = data && (data.status || data.Status) ? (data.status || data.Status) : '-';
          document.getElementById('aiScore').textContent = data && (data.score !== undefined && data.score !== null) ? String(data.score ?? data.Score ?? '-') : '-';
          document.getElementById('aiFeedback').textContent = data && (data.feedback || data.Feedback || data.feedbackText) ? (data.feedback || data.Feedback || data.feedbackText) : '-';
        } catch (err) {
          statusEl.textContent = 'Network error';
          document.getElementById('resultArea').textContent = String(err);
        }
      });

      document.getElementById('lookupBtn').addEventListener('click', async () => {
        const id = document.getElementById('lookupId').value.trim();
        if (!id) return;
        document.getElementById('resultArea').textContent = 'Looking up...';
        try {
          const r = await fetch(`/api/get/${encodeURIComponent(id)}`);
            if (r.status === 200) {
            const data = await r.json();
            document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
            // Show AI review fields if present
            document.getElementById('aiStatus').textContent = data.status || '-';
            document.getElementById('aiScore').textContent = (data.score !== undefined && data.score !== null) ? String(data.score) : '-';
            document.getElementById('aiFeedback').textContent = data.feedback || data.feedbackText || data.Feedback || '-';
            // Start polling for this submission id so UI receives future reviews
            try { startPollFor(id); } catch(e) { console.warn('startPollFor failed', e); }
          } else {
            const text = await r.text();
            document.getElementById('resultArea').textContent = text;
            document.getElementById('aiStatus').textContent = '-';
            document.getElementById('aiScore').textContent = '-';
            document.getElementById('aiFeedback').textContent = '-';
          }
        } catch (err) {
          document.getElementById('resultArea').textContent = String(err);
          document.getElementById('aiStatus').textContent = '-';
          document.getElementById('aiScore').textContent = '-';
        }
      });
    </script>

  </body>
</html>
