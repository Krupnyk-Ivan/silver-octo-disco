<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TacticalMed - Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="row mb-4">
        <div class="col">
          <h1 class="h3">Короткий тест</h1>
          <p class="text-muted">Відповідь на запитання нижче та надішліть результати. Кожна відповідь створює надсилання.</p>
        </div>
        <div class="col-auto">
          <a href="/" class="btn btn-outline-secondary">Назад</a>
        </div>
      </div>

      <div class="d-flex align-items-center mb-3">
        <div class="me-3">
          <label class="form-label mb-0">Тривалість (хв):</label>
          <select id="durationMinutes" class="form-select">
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="me-3">
          <button id="startQuiz" class="btn btn-success">Почати тест</button>
        </div>
        <div>
          <div>Час: <span id="timerDisplay">--:--</span></div>
          <div class="progress mt-1" style="width:200px;">
            <div id="timerBar" class="progress-bar" role="progressbar" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div id="quizArea">
        <div class="text-muted">Натисніть «Почати тест», щоб завантажити запитання та запустити таймер.</div>
      </div>

      <div class="mt-3">
        <button id="submitQuiz" class="btn btn-primary" disabled>Надіслати тест</button>
        <span id="quizStatus" class="ms-3"></span>
      </div>

      <div class="mt-4">
        <h5>Відповіді</h5>
        <pre id="responses" style="white-space:pre-wrap;word-break:break-word;">-</pre>
      </div>
    </div>

    <script>
      let questions = [];
      let quizStarted = false;
      let remainingSeconds = 0;
      let timerInterval = null;

      function formatTime(sec) {
        const m = Math.floor(sec/60).toString().padStart(2,'0');
        const s = Math.floor(sec%60).toString().padStart(2,'0');
        return `${m}:${s}`;
      }

      function updateTimerUI() {
        const disp = document.getElementById('timerDisplay');
        const bar = document.getElementById('timerBar');
        if (!disp || !bar) return;
        disp.textContent = formatTime(remainingSeconds);
        const total = Number(document.getElementById('durationMinutes').value) * 60;
        const pct = Math.max(0, Math.min(100, ((total - remainingSeconds) / total) * 100));
        bar.style.width = pct + '%';
      }

      function startTimer() {
        const minutes = Number(document.getElementById('durationMinutes').value) || 5;
        remainingSeconds = minutes * 60;
        updateTimerUI();
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          remainingSeconds -= 1;
          updateTimerUI();
          if (remainingSeconds <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            // Time is up - auto-submit
            document.getElementById('quizStatus').textContent = 'Час вичерпано — автоматична відправка...';
            submitQuiz();
          }
        }, 1000);
      }

      async function loadRandom(count = 5) {
        const area = document.getElementById('quizArea');
        area.innerHTML = '<div class="text-muted">Завантаження запитань...</div>';
        try {
          const r = await fetch(`/api/questions/random/${count}`);
          if (r.status !== 200) {
            area.innerHTML = '<div class="text-danger">Не вдалося завантажити запитання</div>';
            return;
          }
          questions = await r.json();
          if (!Array.isArray(questions) || questions.length === 0) {
            area.innerHTML = '<div class="text-muted">Запитань немає.</div>';
            return;
          }

          const out = document.createElement('div');
          questions.forEach((q, idx) => {
            const card = document.createElement('div');
            card.className = 'card mb-3';
            card.innerHTML = `
              <div class="card-body">
                <h6 class="card-title">Питання ${idx+1}</h6>
                <div class="mb-2"><strong>${(q.title||q.Title||'').toString()}</strong></div>
                <div class="mb-2 text-muted">${(q.text||q.Text||'').toString()}</div>
                <div>
                  <textarea class="form-control answer-input" data-idx="${idx}" rows="3" placeholder="Ваша відповідь..." disabled></textarea>
                </div>
              </div>
            `;
            out.appendChild(card);
          });
          area.innerHTML = '';
          area.appendChild(out);
        } catch (e) {
          area.innerHTML = '<div class="text-danger">Помилка при завантаженні запитань</div>';
          console.error(e);
        }
      }

      async function submitQuiz() {
        const status = document.getElementById('quizStatus');
        status.textContent = 'Надсилається...';
        const responsesEl = document.getElementById('responses');
        const answers = Array.from(document.querySelectorAll('.answer-input')).map(el => ({ idx: el.dataset.idx, text: el.value }));
        const results = [];
        // include timing metadata
        const durationMinutes = Number(document.getElementById('durationMinutes').value) || 5;
        const payloadCommon = {
          QuizDurationMinutes: durationMinutes,
          QuizStartedAtUtc: quizStarted ? new Date(Date.now() - (durationMinutes*60 - remainingSeconds)*1000).toISOString() : new Date().toISOString()
        };

        for (let a of answers) {
          const q = questions[Number(a.idx)];
          if (!q) continue;
          const payload = {
            StudentId: 'quiz-user',
            Question: a.text && a.text.trim() ? a.text : (q.text || q.Text || ''),
            AnswerText: a.text || ''
          };
          // merge timing metadata (server ignores unknown fields but it's useful for logs)
          Object.assign(payload, payloadCommon);
          try {
            const r = await fetch('/api/submit', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            const data = await r.json().catch(() => ({ status: r.status, text: r.statusText }));
            results.push({ questionId: q.id || q.Id, status: r.status, response: data });
          } catch (err) {
            results.push({ questionId: q.id || q.Id, status: 'error', error: String(err) });
          }
        }
        responsesEl.textContent = JSON.stringify(results, null, 2);
        status.textContent = 'Надіслано';
      }

      document.getElementById('submitQuiz').addEventListener('click', () => submitQuiz());

      document.getElementById('startQuiz').addEventListener('click', async () => {
        // Load questions and enable inputs, start timer
        await loadRandom(5);
        quizStarted = true;
        startTimer();
        // enable inputs and submit button
        document.querySelectorAll('.answer-input').forEach(el => el.removeAttribute('disabled'));
        document.getElementById('submitQuiz').removeAttribute('disabled');
        document.getElementById('quizStatus').textContent = 'Тест запущено';
      });

      // optional: allow pressing Enter+Ctrl to submit
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitQuiz();
      });
    </script>
  </body>
</html>
